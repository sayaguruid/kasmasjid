<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Aplikasi Kas Masjid</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* ... (SEMUA KODE CSS ANDA ... persis seperti yang Anda berikan, tidak perlu diubah) ... */
    :root {
      --bg-main: #fcfcfc;
      --bg-card: #ffffff;
      --text-primary: #333333;
      --text-secondary: #777777;
      --border-color: #eee;
      --btn-primary-bg: #333;
      --btn-primary-hover: #555;
      --color-green: #008000;
      --color-red: #d93025;
    }
    body {
      padding: 0;
      background-color: var(--bg-main);
      padding-top: 70px;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: var(--text-primary);
    }
    /* ... (SISA CSS ANDA) ... */
    .pagination .page-item.disabled .page-link {
        color: #ccc;
        border-color: var(--border-color);
    }
  </style>
</head>
<body>

    <nav class="navbar navbar-light bg-white border-bottom fixed-top">
    <div class="container-fluid" style="max-width: 720px; margin: auto;">
      <div>
        <span class="navbar-brand mb-0 h1">Aplikasi Kas Masjid</span>
      </div>
      <div class="d-flex">
        <button class="btn btn-dark" type="button" data-bs-toggle="modal" data-bs-target="#inputModal" title="Input Transaksi Baru" id="plusButtonNav" style="display: none;">
          <i class="bi bi-plus-lg" style="font-size: 1.5rem;"></i>
        </button>
        <button class="btn btn-dark ms-2" type="button" data-bs-toggle="modal" data-bs-target="#loginModal" id="loginButtonNav">
          <i class="bi bi-person-fill-lock"></i> Login Admin
        </button>
        <button class="btn btn-outline-danger ms-2" type="button" id="logoutButtonNav" style="display: none;">
          <i class="bi bi-box-arrow-right"></i> Logout
        </button>
      </div>
    </div>
  </nav>
  <div class="container bg-white p-3 p-md-4 rounded shadow-sm">
      </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>

  <script>
    // ==========================================================
    // PERUBAHAN BESAR PADA JAVASCRIPT
    // ==========================================================
    
    // **PENTING**: Ganti dengan URL Web App Anda dari Langkah 3
    const GAS_WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzUyy3cFoPCwcwHTJXVgOpPq6TkkMUxWYtZcEsQst1kuSL9V5xVa63EGkWm16sFC3UJkQ/exec";
    
    // --- 0. FUNGSI HELPER BARU (PENGGANTI google.script.run) ---
    /**
     * Fungsi ini menggantikan google.script.run
     * Fungsi ini memanggil API GAS Anda menggunakan fetch()
     */
    function callGasApi(action, payload = {}) {
      // Fungsi ini mengembalikan "Promise", mirip dengan .withSuccessHandler
      return fetch(GAS_WEB_APP_URL, {
        method: 'POST',
        mode: 'cors', // Wajib ada untuk komunikasi lintas domain
        headers: {
          // Trik agar GAS tidak memerlukan pre-flight 'OPTIONS'
          'Content-Type': 'text/plain;charset=utf-8', 
        },
        body: JSON.stringify({ action: action, payload: payload })
      })
      .then(response => {
        if (!response.ok) {
          // Tangani error jaringan
          throw new Error(`Network response error: ${response.statusText}`);
        }
        return response.json();
      })
      .then(result => {
        // Tangani error yang dikirim dari logika GAS (cth: password salah)
        if (result.status === 'error' || result.error) {
          throw new Error(result.message || result.error || 'Unknown script error');
        }
        // Jika sukses, kembalikan datanya
        return result;
      });
    }
    
    // --- 1. GLOBAL STATE & VARIABLES ---
    // (Tidak berubah)
    let isAdmin = false;
    let adminPassword = null;
    let allCategories = {};
    let editModalInstance = null;
    let inputModalInstance = null;
    let loginModalInstance = null;
    const ITEMS_PER_PAGE = 20;
    let historyCurrentPage = 1;
    let historyTotalPages = 1;
    let historyCurrentCategory = null;

    // --- 2. INITIALIZATION ---
    // (Tidak berubah)
    document.addEventListener("DOMContentLoaded", function() {
      editModalInstance = new bootstrap.Modal(document.getElementById('editModal'));
      inputModalInstance = new bootstrap.Modal(document.getElementById('inputModal'));
      loginModalInstance = new bootstrap.Modal(document.getElementById('loginModal'));
      document.getElementById('logoutButtonNav').addEventListener('click', handleLogout);
      checkLoginStatus();
      const dashboardTab = document.getElementById('dashboard-tab');
      if (dashboardTab) {
        loadDashboard();
        dashboardTab.addEventListener('shown.bs.tab', loadDashboard);
      }
      document.getElementById('loadHistoryBtn').addEventListener('click', () => loadHistory(1));
    });

    // --- 3. AUTHENTICATION & SESSION ---
    // (Semua 'google.script.run' diganti 'callGasApi')

    function checkLoginStatus() {
      const storedPassword = localStorage.getItem("admin_password");
      if (storedPassword) {
        toggleButtonSpinner('loginButtonNav', true, '...');
        // **PERUBAHAN**
        callGasApi('verifyPassword', { password: storedPassword })
          .then(onLoginSuccess)
          .catch(onLoginCheckFailure);
      } else {
        updateUI("guest");
      }
    }
    function handleLoginSubmit(event) {
      event.preventDefault();
      const passwordInput = document.getElementById('loginPassword').value;
      const errorMessage = document.getElementById('loginErrorMessage');
      toggleButtonSpinner('loginButton', true, 'Login');
      errorMessage.style.display = 'none';
      // **PERUBAHAN**
      callGasApi('verifyPassword', { password: passwordInput })
        .then(response => onLoginSuccess(response, passwordInput))
        .catch(onLoginFailure);
    }
    // Fungsi (onLoginSuccess, onLoginFailure, onLoginCheckFailure, handleLogout) tidak berubah

    // --- 4. DATA LOADING & HANDLING ---
    // (Semua 'google.script.run' diganti 'callGasApi')
    
    // Fungsi (loadAdminData) tidak berubah
    function loadDashboard() {
      const contentDiv = document.getElementById('dashboardContent');
      if (!contentDiv) return;
      contentDiv.innerHTML = getDashboardSkeleton();
      document.getElementById('refreshDashboardBtn').disabled = true;
      // **PERUBAHAN**
      callGasApi('getDashboardData', {})
        .then(renderDashboard)
        .catch(renderDashboardError);
    }
    function loadCategories() {
      if (!isAdmin) return;
      // **PERUBAHAN**
      callGasApi('getCategories', { password: adminPassword })
        .then(populateCategories)
        .catch(showError);
    }
    function loadHistory(page = 1) {
      if (!isAdmin) return;
      const selectedValue = document.getElementById('historyCategory').value;
      if (!selectedValue) {
        showMessage('Silakan pilih kategori terlebih dahulu.', 'warning', 'historyMessage');
        return;
      }
      const [kategoriKey, sheetName] = selectedValue.split('::');
      if (historyCurrentCategory && historyCurrentCategory.sheetName !== sheetName) {
        page = 1;
      }
      historyCurrentPage = page;
      historyCurrentCategory = { kategoriKey, sheetName };
      const contentDiv = document.getElementById('historyContent');
      toggleButtonSpinner('loadHistoryBtn', true, 'Tampilkan');
      if (contentDiv) contentDiv.innerHTML = getHistorySkeleton();
      document.getElementById('historyMessage').innerHTML = "";
      document.getElementById('paginationControls').innerHTML = "";
      // **PERUBAHAN**
      callGasApi('getHistoryData', { 
          sheetName: sheetName, 
          page: historyCurrentPage, 
          itemsPerPage: ITEMS_PER_PAGE, 
          password: adminPassword 
        })
        .then(renderHistory)
        .catch(renderHistoryError);
    }

    // --- 5. EVENT HANDLERS (Form Submissions, Clicks) ---
    // (Semua 'google.script.run' diganti 'callGasApi')

    function handleFormSubmit(event) {
      event.preventDefault();
      if (!isAdmin) return;
      toggleButtonSpinner('submitButton', true, 'Simpan Transaksi');
      const formData = { /* ... (tidak berubah) ... */
        tanggal: document.getElementById('tanggal').value,
        jenis: document.getElementById('jenis').value,
        kategoriKey: document.getElementById('kategori').value,
        jumlah: document.getElementById('jumlah').value,
        keterangan_input: document.getElementById('keterangan').value
      };
      // **PERUBAHAN**
      callGasApi('addNewTransaction', { formData: formData, password: adminPassword })
        .then(onSuccess)
        .catch(onError);
    }
    function handleEditFormSubmit(event) {
      event.preventDefault();
      if (!isAdmin) return;
      toggleButtonSpinner('editSubmitButton', true, 'Simpan Perubahan');
      const formData = { /* ... (tidak berubah) ... */
        trxId: document.getElementById('editTrxId').value,
        tanggal: document.getElementById('editTanggal').value,
        jumlah: document.getElementById('editJumlah').value,
        keterangan: document.getElementById('editKeterangan').value
      };
      // **PERUBAHAN**
      callGasApi('updateTransaction', { formData: formData, password: adminPassword })
        .then(onHistoryActionSuccess)
        .catch(onEditError);
    }
    function showEditModal(trxId) {
      if (!isAdmin) return;
      editModalInstance.show();
      document.getElementById('editModalLoader').style.display = 'block';
      document.getElementById('editForm').style.display = 'none';
      // **PERUBAHAN**
      callGasApi('getTransactionForEdit', { trxId: trxId, password: adminPassword })
        .then(populateEditModal)
        .catch(onEditError);
    }
    // Fungsi (askDelete) tidak berubah
    function performDelete(trxId, kategoriKey, sheetName) {
      if (!isAdmin) return;
      document.getElementById('historyContent').innerHTML = getHistorySkeleton();
      // **PERUBAHAN**
      callGasApi('deleteTransaction', { 
          trxId: trxId, 
          kategoriKey: kategoriKey, 
          sheetName: sheetName, 
          password: adminPassword 
        })
        .then(onHistoryActionSuccess)
        .catch(renderHistoryError);
    }

    // --- 6. UI RENDERING & DOM MANIPULATION ---
    // (Semua fungsi di bagian ini TIDAK BERUBAH SAMA SEKALI)
    function updateUI(role) { /* ... (sama seperti sebelumnya) ... */ }
    function renderDashboard(data) { /* ... (sama seperti sebelumnya) ... */ }
    function renderDashboardError(error) { /* ... (sama seperti sebelumnya) ... */ }
    function populateCategories(categories) { /* ... (sama seperti sebelumnya) ... */ }
    function renderHistory(response) { /* ... (sama seperti sebelumnya) ... */ }
    function renderHistoryError(error) { /* ... (sama seperti sebelumnya) ... */ }
    function renderPaginationControls(currentPage, totalPages) { /* ... (sama seperti sebelumnya) ... */ }
    function populateEditModal(response) { /* ... (sama seperti sebelumnya) ... */ }
    function toggleKeteranganField() { /* ... (sama seperti sebelumnya) ... */ }
    function setDefaultDate() { /* ... (sama seperti sebelumnya) ... */ }
    
    // --- 7. SERVER RESPONSE HANDLERS (Callbacks) ---
    // (Semua fungsi di bagian ini TIDAK BERUBAH SAMA SEKALI)
    function onSuccess(response) { /* ... (sama seperti sebelumnya) ... */ }
    function onError(error) { /* ... (sama seperti sebelumnya) ... */ }
    function onHistoryActionSuccess(response) { /* ... (sama seperti sebelumnya) ... */ }
    function onEditError(error) { /* ... (sama seperti sebelumnya) ... */ }
    function onLoginSuccess(response, passwordInput) { /* ... (sama seperti sebelumnya) ... */ }
    function onLoginFailure(error) { /* ... (sama seperti sebelumnya) ... */ }
    function onLoginCheckFailure(error) { /* ... (sama seperti sebelumnya) ... */ }
    function handleLogout() { /* ... (sama seperti sebelumnya) ... */ }
    
    // --- 8. UTILITY/HELPER FUNCTIONS ---
    // (Semua fungsi di bagian ini TIDAK BERUBAH SAMA SEKALI)
    function getDashboardSkeleton() { /* ... (sama seperti sebelumnya) ... */ }
    function getHistorySkeleton() { /* ... (sama seperti sebelumnya) ... */ }
    function showError(error) { /* ... (sama seperti sebelumnya) ... */ }
    function showMessage(message, type, elementId) { /* ... (sama seperti sebelumnya) ... */ }
    function toggleButtonSpinner(buttonId, showSpinner, buttonText = "Simpan") { /* ... (sama seperti sebelumnya) ... */ }
    function formatCurrency(number) { /* ... (sama seperti sebelumnya) ... */ }
  </script>

</body>
</html>
